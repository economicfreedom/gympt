<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script>
        $(document).ready(function () {
            console.log(Number($("#board_id").val()))

            $.ajax({
                url: "/graphql", // GraphQL 서버의 엔드포인트 URL을 적어주세요.
                contentType: "application/json",
                type: 'POST',
                // headers: {
                //     "Authorization": "Bearer your-token" // 만약 필요한 경우, 인증 토큰을 헤더에 추가하세요.
                // },
                data: JSON.stringify({
                    query: `
      query ($id: ID) {
        findById(id: $id) {
          id
          nickName
          title
          content
          createdAt
          boardType
         replyList{
         id
         content
         user{
         uid
         nickName
         }
         }
        }
      }`,

                    variables: {
                        id: Number($("#board_id").val()), // 여기에 필요한 ID를 넣으세요.
                    },
                }),
                success: function (response) {
                    console.log(response);
                    $("#content").text(response.data.findById.content);
                    $(".post-title").text("제목 : " + "[" + response.data.findById.boardType + "]" + response.data.findById.title);
                    $(".post-author").text("작성자 : " + response.data.findById.nickName);
                    var list = response.data.findById.replyList;
                    let loggedInUser = $('#loggedInUser').val();
                    if (list.length > 0) {
                        $(".delete-button").show()
                        $(".edit-button").show()
                    }
                    console.log(loggedInUser + "로그드 유저")
                    for (let i = 0; i < list.length; i++) {
                        console.log(list[i].user.nickName)
                        console.log(list[i].content)
                        let uid = list[i].user.uid;
                        let reply = '<div class="test">' +
                            '<div class="comment-author">' + list[i].user.nickName + '</div>' +
                            '<div class="comment-content">' + list[i].content + '</div>';

                        if (uid === $("#normal").val())
                            reply += '<button class="edit-button">수정</button>' + '<button class="delete-button" >삭제</button>'


                        reply += '</div>';

                        $('.comments-list').append(reply);


                    }
                    // console.log(response.data.findById.replyList.content)
                    // console.log(response.data.findById.replyList.user.nickName)/
                    if (list.length === 0) {

                    }
                },
                error: function (err) {
                    console.log(err);
                    // 에러 처리
                }
            });
            $("#delete").click(function () {

                // 삭제할 게시물의 ID를 가져옵니다.
                const idToDelete = Number($("#board_id").val());

                // 서버로 삭제 요청을 보냅니다.
                $.ajax({
                    url: "/graphql",
                    contentType: "application/json",
                    type: 'POST',
                    data: JSON.stringify({
                        query: `
                    mutation ($id: ID!) {
                        deleteBoard(id: $id)
                    }`,
                        variables: {
                            id: idToDelete,
                        },
                    }),
                    success: function (response) {
                        console.log(response);
                        // 서버로부터 응답을 받았으나 실제 응답 내용은 필요에 따라 다를 수 있습니다.
                        // 게시물이 성공적으로 삭제되었다면 응답이 나올 수도 있고, 나오지 않을 수도 있습니다.
                    },
                    error: function (err) {
                        console.log(err);
                        // 에러 처리
                    }
                });
            });


            $("#add-reply").click(function () {
                const board_id_val = $("#board_id").val();
                const board_id = Number(board_id_val);

                console.log('board_id_val:', board_id_val);
                console.log('board_id:', board_id);

                const commentContent = $("#commentContent").val();
                let input_data = {
                    boardId: board_id,
                    content: commentContent,
                }
                console.log(input_data.content + "ddd")

                $.ajax({
                    url: "/graphql",
                    contentType: "application/json",
                    type: 'POST',
                    data: JSON.stringify({
                        query: `mutation AddReply($input: ReplyRequest!) {
            addReply(input: $input) {
                id
                content
            }
        }`,
                        variables: {
                            input: input_data

                        },
                    }),
                    success: function (response) {
                        console.log(response);
                        alert("글이 등록되었습니다.")
                        // 서버로부터 응답을 받았으나 실제 응답 내용은 필요에 따라 다를 수 있습니다.
                        // 게시물이 성공적으로 수정되었다면 응답이 나올 수도 있고, 나오지 않을 수도 있습니다.
                    },
                    error: function (err) {
                        console.log(err);
                        // 에러 처리
                    }
                });


            });
            $('#back-button').click(function () {
                window.history.back();
            });
            $(document).on('click', '.edit-button', function () {
                // 해당 버튼에 가장 가까운 comment-content 클래스를 찾음
                console.log("클릭버튼 눌려짐")
                var commentContent = $(this).closest('.comment').find('.comment-content');
                var commentText = commentContent.text(); // comment의 내용을 가져옴

                // input 태그를 생성하고 comment의 내용을 value로 설정
                var inputTag = $('<input type="text" />').val(commentText);

                // commentContent 요소의 내용을 input 태그로 교체
                commentContent.empty().append(inputTag);

            });

            $(document).on('click', '.delete-button', function () {
                if (confirm('Are you sure you want to delete this comment?')) {
                    $(this).parent('.test').remove();
                }
            });
        });


    </script>
    <style>
        .outer-container {
            border: 1px solid #000; /* This adds a black border around the container */
            padding: 20px; /* This adds some space between the border and the content */
        }

        .container {
            width: 80%;
            margin: 0 auto;
            font-family: Arial, sans-serif;
        }

        .post-title {
            font-size: 2em;
            color: #000; /* Black */
            margin-bottom: 10px;
        }

        .post-author {
            font-size: 1em;
            color: #555; /* Dark Gray */
            margin-bottom: 20px;
        }

        .post-content {
            font-size: 1.2em;
            color: #000; /* Black */
            margin-bottom: 30px;
        }

        .edit-post-button {
            background-color: #000; /* Black */
            color: #FFF; /* White */
            border: none;
            padding: 10px 20px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            margin: 4px 2px;
            cursor: pointer;
        }

        .comments-container {
            margin-top: 30px;
        }

        .comments-container h2 {
            font-size: 1.5em;
            color: #000; /* Black */
            margin-bottom: 20px;
        }

        .comments-list {
            margin-bottom: 30px;
        }

        .test {
            background-color: #EEE; /* Light Gray */
            border: 1px solid #CCC; /* Darker Gray */
            padding: 10px;
            margin: 10px 0;
        }

        .comment-author {
            font-weight: bold;
            color: #000; /* Black */
        }

        .comment-content {
            margin-top: 5px;
            color: #555; /* Dark Gray */
        }

        .comment-form {
            margin-bottom: 50px;
        }

        .comment-form h2 {
            font-size: 1.5em;
            color: #000; /* Black */
            margin-bottom: 20px;
        }

        .comment-form textarea {
            width: 100%;
            height: 150px;
            padding: 12px 20px;
            margin: 8px 0;
            display: inline-block;
            border: 1px solid #CCC; /* Dark Gray */
            box-sizing: border-box;
        }

        #add-reply {
            background-color: #000; /* Black */
            color: #FFF; /* White */
            padding: 14px 20px;
            margin: 8px 0;
            border: none;
            cursor: pointer;
            width: 100%;
        }

        #add-reply:hover {
            opacity: 0.8;
        }

        nav {
            background-color: #f8f8f8; /* Light Gray */
            padding: 10px;
        }

        #back-button {
            background-color: #000; /* Black */
            color: #FFF; /* White */
            border: none;
            padding: 10px;
            cursor: pointer;
        }

        #back-button:hover {
            background-color: #555; /* Dark Gray */
        }

        .edit-button, .delete-button {
            background-color: #000; /* Black */
            color: #FFF; /* White */
            border: none;
            padding: 5px;
            cursor: pointer;
            margin: 5px;
        }

        .edit-button:hover, .delete-button:hover {
            background-color: #555; /* Dark Gray */
        }
    </style>
</head>
<body>

<input type="hidden" th:value="${testId}" hidden="hidden" id="board_id">
<input type="hidden" th:value="${normal}" hidden="hidden" id="normal">
<!--<input type="hidden" id="loggedInUser" th:value="${#authentication.getPrincipal() != null ? #authentication.getPrincipal().username : ''}">-->


<div class="outer-container">
    <nav>
        <button id="back-button"><<<</button>
    </nav>
    <div class="container">
        <div class="post-title">Sample Post Title</div>
        <div class="post-author">Posted by John Doe</div>
        <div class="post-content">
            <p id="content">

            </p>
            <a th:href="@{|/modify/${id}|}">
                <button class="edit-post-button"
                        sec:authorize="isAuthenticated()"
                        th:if="${uid != null and #authentication.getPrincipal().getUsername() == uid}"
                        th:text="수정">

                </button>
            </a>
            <button class="edit-post-button"
                    sec:authorize="isAuthenticated()"
                    th:if="${uid != null and #authentication.getPrincipal().getUsername() == uid}"
                    th:text="삭제"
                    id="delete"
            >삭제
            </button>
        </div>
        <hr>
        <div class="container">
            <h3>댓글</h3>
            <div class="comments-list">
                <!-- Comments will be appended here -->

            </div>
        </div>
        <hr>

        <div class="comment-form">
            <h2>Add a Comment</h2>
            <div>
                <label for="commentContent">Comment:</label>
                <textarea id="commentContent" rows="4" required></textarea>
            </div>
            <button id="add-reply" type="button">Submit Comment</button>
        </div>
    </div>
</div>


</body>
</html>